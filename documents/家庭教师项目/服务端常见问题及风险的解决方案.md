## 1. 账号唯一登录

对于长连接类型的游戏，玩家的操作通常由服务端一个单独的代理对象处理。好处是玩家数据持续在内存中，玩家数据的修改只需要修改内存中的数据，之后回写到数据库即可，极大的提高了处理效率。

在这种处理方式下，服务端中同一玩家的代理对象只应该存在一个，如果出现副本对象，将会导致数据错乱。要避免副本对象，需要保证同一账号只能唯一登录到服务器。

服务器使用以下方案保证账号的唯一登录。

### 1.1 家庭教师服务端玩家代理对象的管理

- 家庭教师服务端的玩家代理对象由gameserver管理，通过userid索引，对于单一gameserver,账号保证唯一登录。
- gameserver可以动态伸缩，根据userid将玩家hash到不同的gameserver上。运行中动态伸缩gameserver的时候可能存在同一账号被分配到不同gameserver的情况（玩家A已经登录gameserverA,此时增加一台gameserverB，玩家A再次发起登录请求，玩家A被分配到gameserverB,此时玩家A在gameserverA和gameserverB同时存在）。

### 1.2 解决方案

数据库中存在一个记录, userid,gameserver id。

gameserver处理玩家登录时，需要确保这条记录为空/记录的gameserver id为空。下面是利用flyfish cas命令操作这条记录的伪代码。

	/* 如果记录不存在，设置记录
	 * 如果记录存在但gameserver_id = nil,设置记录
	 */
	ret = CompareAndSetNx(userid,oldgameserver_id = nil,gameserver_id)
	if ret.ok {
		//设置成功
	} else {
		//通告玩家当前所在gameserver踢人下线
		notifyKick(ret.gameserver_id)
		//通知玩家重新发起登录请求
		notifyUserLoginRetry()
	}



由以上伪代码可以看到，当玩家已经在别的gameserverB上线时，当前gameserverA会向gameserverB发送踢人请求，并通知客户端重试。gameserverB中的玩家下线时会将gameserver_id设置为nil，玩家后续的登录请求将会正确执行。



### 1.3 存在的问题

gameserver机器长时间硬件故障，之前登录在上面的玩家将无法正常执行下线流程，踢人流程也因为进程没有启动而无法执行，导致玩家卡登录。

解决办法：

发现gameserver出现长时间故障时，用相同的gameserver_id在其它机器上重启gameserver。


## 2. 数据存储

家庭教师项目采用关系数据库+内存缓存的2级存储方案。

关系数据库使用腾讯云的pgsql或mysql,缓存层使用自研flyfish kv缓存。

### 2.1 冷热数据分离

家庭教师为长连接类型的游戏，在线玩家的数据将会频繁修改。在一段时期内，活跃玩家的数据频繁被访问。为了加快数据修改/读取的效率，最近以及将来最有可能被频繁访问的数据应该缓存在内存中。

flyfish kv提供了统一的数据访问接口，游戏服务通过flyfish kv提供的接口访问数据，由flyfish kv负责将冷数据从关系数据库载入内存，执行异步脏数据回写，以及缓存剔除。

### 2.2 数据安全性

flyfish kv 基于raft算法实现，数据的变更需要在操作日志被安全复制之后才生效并响应请求方。对于可用性要求较低的场合，例如单一游戏服。flyfish kv可以部署单一副本，这样，当日志写入到本地磁盘后操作即生效。在这种部署方式下，只要物理硬盘不发生故障，数据都不会丢失。

对可用性及安全性要求更高的场合，如全局登录信息数据。可以部署3~5个副本，使得即使在1~2个副本出现故障的情况下，依旧保证服务不中断。

### 2.3 关系数据库故障

在关系数据库发生故障的情况下，flyfish kv依旧可以提供部分服务。

- 已经缓存在flyfish kv中的数据，可以继续对其执行读写/操作
- 冷数据加载请求无法提供
- 因为无法回写，缓存剔除操作暂停

基于以上三点，当关系数据发生故障时，游戏中已经在线的玩家，只要其主要数据已经被缓存在flyfish kv中，这部分玩家将不会受到任何影响。对于没有被缓存的玩家，他们进入游戏的请求将会因为无法加载冷数据而被拒绝。

### 2.4 性能参数

flyfish kv在部署单一副本的情况下，对于4k的value,每秒可以支持8W/s的写，12W/s的读。

### 2.5 需要注意的问题

- flyfish kv采用异步回写，回写延迟取决于关系数据库的写能力。
- 避免绕过flyfish kv直接操作关系数据库中数据的数据。

## 3. 数据回档

家庭教师项目只能通过关系数据库的备份回档。例如数据库在2020年1月1日早上8点整，建立了一个数据备份。在之后就可以把数据回档到这个时间点。但是，因为flyfish kv异步回写机制，在数据库备份的时候，可能还存在部分数据没有完成回写，因此，在回档时可能出现部分数据丢失的情况。

## 4. 应用层脏数据回写

应用层在处理完数据变更后，应该将内存中的脏数据回写到数据存储层，避免进程崩溃后丢失数据。

flyfish kv提供了及高的写处理能力，可以支持应用程序变更后立即回写。但是，频繁的数据序列化将消耗大量cpu，降低应用程序的处理能力。

合理的方式是根据数据的关键程度采取不同的回写模式：


- 对于关键数据，如充值，背包等，采取立即回写模式。
- 对于没那么关键的数据，如任务，成就等，采用定时回写模式。



## 5. 容量/流量限制

### 5.1 容量
服务端可容纳的同时在线玩家数量受限于以下几个方面：

-  数据存储层提供的访问能力
-  服务进程的处理能力
-  内部网络带宽
-  外部网络带宽

#### 5.1.1  数据存储层提供的访问能力

家庭教师项目使用了玩家代理对象的处理模式，玩家登录后，向数据库加载玩家数据，创建内存代理对象。后续操作改变内存对象的数据，之后回写数据库。因此，对数据存储层的读操作主要发生在玩家登录阶段。当玩家正常游戏之后操作集中在写上。

对回写操作做优先级划分后，平均每个玩家每秒钟的写操作最多2-3次。flyfish kv可以支持2W-2.5W玩家同时在线。

#### 5.1.2 服务进程的处理能力

玩家的操作主要由以下进程负责：

- gameserver: 代理对象的宿主，负责玩家所有非战斗操作的处理。因数据库访问以及外部rpc访问均采用异步模型，负载能力主要受机器cpu影响。gameserver支持动态伸缩，可根据需要扩充容量以支持更大的在线两。
- aoi: 地图视野服务，cpu是其处理瓶颈。可通过合理分线以及将分线部署到多个进程以缓解处理能力。根据压测数据，每线500人上限是一个比较合理的限制。aoi支持动态伸缩，可根据实际需求动态增加分线数量以容纳更多的玩家。
- gateway: 玩家与内部服务器交互的接口进程。负责向内部服务器转发玩家的请求，将来自内部服务器的消息转发给玩家。gateway支持动态伸缩，可根据实际需求动态扩展。
- room/battle: 房间/战斗服务，承载整个游戏分区中玩家的战斗逻辑。作为公共服务，集群部署。按set动态伸缩，可根据实际需求动态扩展。

#### 5.1.3 内部网络带宽

内部网络带宽的占用主要来自两个方面：

- 数据存储的访问：可通过合理的合并回写请求以有效，以及开启传输压缩方式有效降低网络传输的数据量。
- 视野服务大量的对象位置信息广播：视野服务的消息发往gateway,由gateway发往玩家。如果消息需要发往gateway上的多个玩家，则应该只发送一条消息，在消息中携带应转发玩家的id。由gateway负责转发。

#### 5.1.4 外部带宽

玩家的上行带宽一般很小可以忽略不计。

主要关心下行带宽。下行带宽主要的流量将来自视野消息。应合理的设计视野同步消息的结构，有需要时可针对大的消息做压缩梳理。

### 5.2 流量控制

* 登录限流：通过令牌桶机制，限制每秒登录玩家数。
* gameserver: gameserver为单线程结构，来自网络的消息push到主任务处理队列。来自玩家的命令被封装到任务中，由主线程提取，并执行。如果当前玩家的命令队列为空，则执行命令，否则将命令append到玩家命令队列尾部。玩家命令队列有空间限制，如果超过限制，append操作失败，向用户返回busy。 为了避免单个玩家的命令被快速消费，玩家命令结束后如果命令队列中还有剩余命令，不会立即启动排队命令的执行，而是再次向主任务处理队列投递处理请求，待到主线程提取任务后继续执行。


## 6. 动态伸缩

gateserver,gameserver,aioserver以及room/battle server均可动态伸缩。其中gateserver,gameserver,aioserver归属单个服务器组。伸缩均以单个进程为单位，可在运行中动态添加/减少服务进程以实现扩容/缩容。

room/battle server作为整个大分区的共享服务，以set为单位扩容/缩容，每个set配置固定数量的服务进程。

## 7. 不停服更新

### 7.1 游戏配置更新
游戏中的配置由excel,toml以及xml文件组成，只需要上传最新配置文件，触发服务器重新加载配置即可实现配置更新。


### 7.2 代码更新

家庭教师服务端采用golang编写，不具备脚本语言动态更新代码的能力。因此，家庭教师采用滚服的方式更新二进制可执行文件。下面以gameserver的更新举例更新流程：

1. 上传二进制可执行文件。
2. 发送更新控制命令，让当前所有gameserver进入待更新状态，在此状态下的gameserver不再接受任何新的玩家请求（包括登录请求）。继续处理未完成的命令，当玩家的命令队列全部执行完毕后，将玩家下线，通知玩家发起重登请求。
3. 启动新的gameserver实例。
4. 玩家发起重登请求，请求被分配到新启动的gameserver进程。
5. 待更新进程中所有玩家均完成下线后，进程关闭。


## 8. 外挂防止

家庭教师项目战斗以及所有与玩家数据相关的逻辑均由服务端控制。对客户端上传的操作请求均做了严格的数据校验，校验不通过的请求不会执行，因此不会出现外挂客户端非法修改数据的情况。

针对协议类脱机挂问题，服务端主要通过加强协议破解难度来防止，手段包括：

* 协议加密
* 协议混淆


## 9. 监控系统
见监控系统单独文档
## 10. 日志及统计
见日志及统计单独文档

## 11. 功能开关

线上运行的游戏可能因为错误的配置或者代码的bug产生一些非预期行为。这种非预期的行为可能导致系统不稳定，也可能被玩家非法利用获得巨大收益。

这些问题可能是由某个系统或操作导致的，如果这些问题会导致非常严重的影响，如玩家利用漏洞刷钱。服务器应该具备一种手段，在不停止整体服务的情况下，关闭出问题的功能或操作。

家庭教师服务端提供功能开关支持，可以单独关闭某个操作协议或者整个功能模块。在重新开启前涉及的功能处于关闭状态，不响应任何操作请求，其它正常的功能则不受影响。





































