## 负载均衡

LB（Load Balance 负载均衡）
LB 分配流量通过 优先级，计数器 条件分派。优先级越高越先获得流量，计数器归0后该服务不会分配流量，移至下一优先级。
若所有服务计数器都归0，则等待下一次server上报。LB 保留请求。

- 优先级：LB 分配流量的纬度。优先级越高，流量越先分配。
- 计数器：LB 统计每个 server 可代理的流量。计数器归0则不能代理流量。由 server 触发计数器数量重置。

平滑加权轮训调度算法 SWRR算法，避免压力全在优先级高的服务上。


### 优先级、计数器

1.计算计数器：每单位时间当前server只处理的请求上限。单位时间server可处理的请求量 或 （剩余综合资源-10%）/每玩家占用资源量。

1) 根据进程占用物理资源计算得出(推荐)

    已经承载 1000 用户，占用cpu资源 50%。得出用户上限为2000，剩余可承载数 1000。则上报人数应为1000人。
    考虑处理峰值，数据存在不同步情况下，设整个进程可用 90%CPU资源，用户上限为 1800，则上报人数应为800人。
    
    物理资源一般为多纬度的（CPU，内存，磁盘，网络）。获取各纬度占用，计算得到一个总物理资源使用情况（取平均值，取最大值）。

2) 配置文件设置上限 （不推件）
    
    配置文件中指定承载2000人，已经承载 1000 用户，剩余可承载数 1000。则上报人数应为1000人。800人。
      
注1 峰值：本来1000用户占用资源 50%，某一时间点处理更消耗资源的事务，导致该时间点1000用户消耗资源 60%，可承载人数降低。  

注2 数据不同步的地方： 用户在lb上拿到了该去往的服务器，但是请求还没有到达该服务器。这时该服务重新计算了可承载人数，实际不包含已经在请求过程中的人数。

处理上述情况，每次上报按照 剩余可承载人数的一定比例 上报。直到低于某个阀值，才上报剩余所有可承载数。
例剩余可承载数 1000，但这次只上报50% 500人。可承载数低于200人时，上报200人。
可一定程度避免上述情况，最终结果由各server自行控制。

2.计算优先级：可根据物理机状态确定（占用资源越低，优先级越高）。

优先级 1～10，1不服务状态，10最高优先级。 可根据综合资源每10%为一档。


### 多 lb 设计。

单lb，消息处理量过大，宕机后整个系统无服务。
多lb，降低但进程处理信息量；单个lb宕机后，由其他lb代理不影响系统对外服务。

每个lb只负责分配server部分流量。 1个lb负责分配100%流量，2个lb各分担50%，3个各担33%，类推。
各server需知道当前有多少个lb来分配自身流量，根据数量在等分流量。

一个server会连接多个lb，通过tcp连接和上报确定相互状态。
- 若某个lb宕机。server的流量均分到剩余lb上，由其他lb管理。
- 若server宕机。lb移除该server的流量管理，请求交给其他存活server。
- 若都不宕机，只是网络闪断或堵塞。 llb移除该server的流量管理，server流量转交给其他lb。

![多lb断线实例图](res/teacher-server/mlb.jpg)

### 无服务处理

1.当前没有服务能继续分配流量（优先级最低，计数器归0），怎么办？
- 由该LB启动一个服务，服务上报注册，将新流量接入。
- 报警，人工处理

2.若当前没有服务能继续分配流量（计数器归0）
请求保留，等待 优先级不是最低 的一个服务上报，然后将请求分配到该服务。请求没有处理完，重复该过程。
直到所有服务优先级最低（即情况1）或 超时 返回用户Retry。

### 接入项目

lb 上需指定 代理的服务类型，gate、game、battle。用于 合并代理后的类型查询 和 跨集群。

1.系统集群

多lb设计，单个lb代理多种类型gate，game。
请求时，带上查询类型。lb根据类型、优先规则返回一个可用地址。若返回空，则当前系统没有可服务的服务器，响应客户端重试。

由于玩家离线后，有一段时间保留数据。故希望再次上线时能将请求接回到原服务。

选取gate，在login服务逻辑上根据账号查询数据库，若登陆标记还在，直接将请求转到原服务。若没有，到lb获取一个可用服务地址。
注： 现在数据库标记为game的地址，不能找到其上游的gate。 需要调整数据库标记为gate地址。

选取game，若gate上已存在玩家数据，直接将请求发往对应game。若不存在，到lb获取一个可用服务地址。

![登陆选服流程](res/teacher-server/login-lb.jpg)

2.战斗集群

多lb设计，单个lb只代理battle服务。
请求时，带上查询类型。lb根据类型、优先规则返回一个可用地址。若返回空，则当前系统没有可服务的服务器，响应客户端重试。


3. 跨集群

通过 harbor 通讯。根据 lb 上代理的服务类型可区分当前集群类型。

系统-战斗 ： 需要一个 battle 类型的服务，本集群lb上没有，通过harbor到战斗集群（系统集群lb不代理battle类型服务）选择到 battle 服务。
系统-系统 ： 需要一个 game。 本集群无可用服务，通过harbor到另一个系统集群（战斗集群不代理game类型服务）选择到 game 服务。

