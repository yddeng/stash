<h2>1. 定义</h2>

逻辑时间系统是一个进程唯一的功能模块，用于维护服务器组的逻辑时间。一组服务器在正式开服前，需要在配置文件中设置服务器的逻辑开服时间。服务器组正式启动时，由逻辑时间系统读取配置文件，生成系统数据，随后负责系统数据的维护，并提供逻辑时间相关的功能接口。逻辑时间系统分为 主、从两种运行模式，其中主为单点，负责更新和保存系统数据；从为多点，只负责读取系统数据。

由于服务器组的逻辑时钟在每次关机时都会停摆，服务器重开机时恢复运行。所以在关机时，逻辑时间系统需要记录关机状态，以便于重开机后对逻辑时间进行调整。

<h2>2. 实现</h2>

逻辑时间系统实现于`node/globalservice/logictimesys`。

<h3>2.1 系统数据</h3>

逻辑时间系统包含以下数据：

- **开服逻辑时间**：值为时间戳，由配置的开服时间转换得到。
- **开服系统时间**：值为时间戳，由撇之的开服时间转换得到。
- **关机系统时间**：值为时间戳，记录服务器前一次关机的时间。
- **累计中断系统时间**：服务器从初次开机到现在共停机多长时间。
- **状态标记**：目前用于记录服务器是否正常关机。如果服务器意外宕机，关机标记不会设置。

系统数据使用项目自研的数据库系统进行维护。

<h3>2.2 配置格式</h3>

应客户端需求，逻辑时间系统的配置文件格式采用 **Unity-YAML**。可配置**开服逻辑时间**、**开服系统时间**、<a href="逻辑时间.md#monthsetting"><b>月份设置</b></a>等参数。具体内容如下。

```yaml
%YAML 1.1
%TAG !u! tag:unity3d.com,2011:
--- !u!114 &11400000
MonoBehaviour:
  # 此处省略 Unity 相关配置

	timeVelocityRatio: 30	# 时间变化率
  openServiceTime: "2020-08-08 08:08"	# 开服逻辑时间
  openSystemTime: "2020-08-08 08:08" # 开服系统时间
  month:	# 月份配置，每月单独配置季节和时段, 需配置12个月
  - monthID: 1	# 月份 ID，1 代表 1 月
    season: 1	# 所属季节
		# 以下是各时段的起始时间
		weeHoursTime:
      month: 0
      day: 0
      hour: 0
      minute: 0
    sunriseTime:
      month: 0
      day: 0
      hour: 6
      minute: 30
    noonTime:
      month: 0
      day: 0
      hour: 12
      minute: 0
    eveningTime:
      month: 0
      day: 0
      hour: 18
      minute: 0
```

<h3>2.3 主/从模式</h3>

逻辑时间系统具备主、从模式。两种模式都会读取系统数据，并对外提供逻辑时间的相关功能。区别在只由主模式维护数据。例如，以主模式启动逻辑时间系统的服务进程，在初次开机时生成系统数据，正常关机时记录关机状态，重开机时更新累计中断时长等。

<h3>2.4 创建逻辑时间管理器</h3>

逻辑时间系统内部使用<a href="逻辑时间.md#timemgr"><b>逻辑时间管理器</b></a>计算和获取逻辑时间，提供<a href="逻辑时间.md#timer"><b>逻辑时间定时器</b></a>功能。在创建逻辑时间管理器时，需要调整<a href="逻辑时间.md#sto"><b>系统时间原点</b></a>以应用累计中断时间。

<h2>3. 使用</h2>

启动：

```go
// 主/从 模式
master := true/false
logictimesys.Start(master, cfgFilePath, dbClient, logger)
```

停止:

```go
logictimesys.Stop()
```

逻辑时间功能:

```go
timeMgr := logictimesys.TimeMgr()
timeMgr.Now()
timeMgr.CreateXXXTimer(...)
```
<h2>4. Todo List</h2>

- [ ] 实现“逻辑时间偏移设置”调试功能。
