## 协议号混淆

### 目的

- 防止抓包后，伪造请求。
- 同一条协议，每次上行的协议号不同。

### 混淆规则

只在客户端上行消息上做混淆。由服务器生成随机种子，下发给客户端。两端调用次数一致，保证随机数一致。

- 客户端 -- 构造消息时调用一次。
- 服务器 -- 解析消息时调用一次。

login、gameLogin、reconnect、heartbeat 这四条协议id不参与混淆。

gameLogin、reconnect 玩家登陆、重连，服务器生成一个随机种子，初始化并下发。

``` 
    seed := time.Now().Unix()
    r := rand.New(rand.NewSource(seed))
```

### 具体实现

1. 一份前后端一致的伪随机序列。长度为 1024 。

2. 初始偏移值。服务器下发随机种子：时间戳。

- 种子为质数。hash = a % 1024 。
- 为奇数。hash = (a + 2 + (a << 1)) % 1024 ^ 256。
- 为偶数。hash = （a % 1024） ^ 256  。 

3. 生成协议号。

- coder 的 cmd 为2字节，最大为 65535。
- 协议号大于10，保留 1-10 的协议号。（避免生成的协议号与原保留的协议号冲突）

`id := （(r.Int() + cmd ) % 65525）+ 11`

## 不一致的情况

1. 网络丢包。
2. 客户端构造数据包，但是没有投递到网络（队列满，断线）
3. 服务器队列满，丢包。

## 调用次数一致设计

只存在 客户端多调，服务器少调。
在客户端上传时携带调用次数，服务器再多调用 (c - s) 次，保持一致。

- 服务器调用 > 客户端调用次数
- 相同调用次数，协议号反解码后协议对应不上

以上情况，客户端作弊。



