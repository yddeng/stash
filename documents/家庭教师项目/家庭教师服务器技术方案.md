## 1.总体结构图

![image-20200211145253529](res/teacher-server/image-20200211145253529.png)

## 2.架构及各服务功能介绍

家庭教师是一个分服游戏。每个服代表了一个游戏世界，每个游戏世界由一个数据库以及各种功能的游戏服务组成。所有的游戏世界共享战斗/房间服务。在下面介绍的服务中，除特别说明的以外均具备动态扩容/缩容能力。

- 网关服务：客户端与游戏世界的通信代理
- 登录服务：对客户端进行验证以及分配网关
- 游戏逻辑服务：玩家在服务端的代理，玩家所有的请求由游戏逻辑服务代理执行。
- 世界服务：维护及处理游戏世界的全局状态（逻辑时间，天气，场景道具，NPC等等），世界服务是游戏世界中唯一存在单点问题的服务。世界服务的故障将导致部分功能不可用，为了防止世界状态的丢失，世界服务需要将状态保存到数据库中，服务器崩溃或停服重启后从数据库中恢复世界状态。
- 视野分线服务：为了避免大量玩家处于同一可视区域导致服务器以及客户端的处理压力，游戏中的玩家被划分到不同的可视区域，每一可视区域即一个分线。
- 战斗/房间服务：战斗/房间服务作为公共服务被所有的游戏世界共享。一组战斗/房间服务构成一组set，集合中的所有服务使用一个单独的数据库。战斗/房间服务的扩容/缩容以set为单位。

## 3. 服务器间数据通信

服务器之间底层使用tcp进行通信，在逻辑上提供节点到节点的单向消息投递以及RPC通信方式

### 3.1 逻辑地址

各节点使用一个32位逻辑地址作为标识，逻辑地址被分为3段，高14位表示服务器组，中8位表示节点类型(255保留给harbor使用),低10位表示实例。

 每个节点可以连接1到多个center服务，连接上center之后将自己的逻辑地址以及内网ip地址上报，center将节点信息广播给所有与本center连接的所有节点。

### 3.2 组内节点间的通信

连接同一center的节点之间互为内部节点，内部节点之间建立直接tcp连接。连接在第一次通信请求时建立，消息直接发往目标节点。

### 3.3 跨组节点的通信

当一个请求的逻辑地址不是内部节点时，消息被转发到组内的harbor节点，所有harbor节点互联，并知道各自所负责的服务器组。harbor节点接收到消息请求后，提取出目标逻辑地址的高14位以获得目标服务器组，让后将消息发往目标服务器组所在的harbor节点，由目标harbar节点负责将消息转发到正确的目的地。

![image-20200211150017559](res/teacher-server/image-20200211150017559.png)

## 4. 数据存储

家庭教师服务端采用自研基于raft算法的多副本强一致kv存储系统。将热点数据缓存在kv层，脏数据异步回写到后端db，被缓存的数据全在内存中，有效的加快了热点数据的读写效率。

![image-20200211150126455](res/teacher-server/image-20200211150126455.png)

​																				fyfish集群部署结构图

![image-20200211150316397](res/teacher-server/image-20200211150316397.png)

​																	数据分片及副本

如上面两图所示，kvstore代表一个数据分片，编号相同的kvstore构成一个raftgroup，整个raftgroup可以在最多N/2-1个节点故障的情况下保持可用。

 因为raft日志记录了数据变更，即使在后端DB出现故障时，对于已在缓存中的数据，flyfish也可以提供读写服务（因为DB故障，回写及加载无法执行，因此flyfish将暂停剔除kv对以及加载新的kv）。

 家庭教师是分服游戏，每个服独享一个db以及flyfish服务以存储玩家游戏数据。每个战斗集群独享一个db以及flyfish服务以存储玩家战报数据。整个游戏共享一个db以及flyfish服务以存储玩家的登录以及位置信息。

 对于登录以及位置信息，其存储的kv对数量大，但v的数据小。玩家每次登录都要访问此服务，对数据的安全性以及可用性要求高。必须采用多kvstore,多数据副本的集群部署方式。

 对于游戏服以及战斗集群，存储故障只会影响部分玩家或部分功能，在节约机器成本的考虑下，可以只部署单flyfish节点。

## 5. 游戏逻辑服务

游戏逻辑服务作为玩家在服务器的代理，承载了几乎所有玩家请求的处理。游戏逻辑服务故障将影响分配到其上的玩家正常游戏。

 游戏逻辑服应满足以下需求

1. 玩家绝不允许同时被分配到两个游戏逻辑服务中:

   游戏逻辑服务采用hash算法将玩家分配到唯一的服务上，玩家登陆时，如果发现服务上已经存在玩家对象，将请求踢除已经存在的玩家对象，并通告客户端重新登陆。当已经存在的玩家对象被踢下线后，玩家将正常登陆。 

   为了防止在动态伸缩时hash算法不一致导致玩家同时登陆到两个不同的服务上，玩家登陆时需要将登陆信息写入到登陆/位置服务上。如果此时玩家没有登陆到任何一个服务上，登陆/位置服务上针对此玩家的条目为空，写入成功。否则，写入失败，返回玩家当前所在服务的地址。请求方向玩家所在服务发出踢人请求，向客户端返回重试错误。

2. 单一游戏逻辑服务的故障只影响其上玩家，其余正常服务上的玩家不受任何影响。

3. 服务可以动态伸缩，在不停服的情况下增加或减少服务的数量。

    增加服务：启动新的服务节点，将向center注册新的服务，网关服务感知到新的游戏逻辑服务后调整hash算法的模，新增服务参与到玩家分配中。

    减少服务：首先通知center服务将目标服务下线，然后通知目标服务上的玩家对象迁移到剩余服务中。完成后目标服务可以停机。



游戏逻辑服务的热更新：

1.  向center通告当前所有逻辑服务进入更新状态，不再参与hash分配。
2. 启动一批新的逻辑服务，参与hash分配。
3. 通告旧服务执行迁移，将其上对象转移到新的逻辑服务上。
4. 迁移完成的服务停机。



## 6. 世界

世界服务为游戏服中唯一的单点服务，其职责为维护全局逻辑时间，全局天气状态，全局NPC以及全局场景道具。

 世界服务故障将导致某些全局功能无法提供服务，例如NPC不再移动，场景道具的状态无法变更，玩家无法请求进入地图（已经在地图中的玩家，只要所处分线服务正常则不受影响）。

 为了避免全局状态的丢失，以及让崩溃服务可以快速恢复。所有全局状态应及时存储到数据库中。当服务崩溃后可以快速从数据库中恢复世界状态。

## 7. 视野分线

如果所有的玩家都在同一视野区域，将对服务端的视野同步造成极大压力。为此，进入地图的玩家将被分配到不同的视野区域中，每一个视野区域称为一个分线。只有在同一分线中的玩家才互相可视（全局对象不受分线影响）。

 玩家进入地图时，首先向世界服务请求分配分线，因此，世界服务的故障会导致分配失败，玩家无法进入地图。

## 8. 流量控制

对于玩家请求，服务端采用了2级流控。

 

第一级网关服务：每个玩家/连接运行一个单独的goroutine，此goroutine负责接收来自玩家的网络包，接收到完整的网络包后使用同步rpc将此网络包投递到游戏逻辑服务。游戏逻辑服务接收包之后响应rpc（只是接收并未处理）,goroutime重复此流程。因此如果游戏逻辑服务繁忙导致rpc响应慢，网关将不会继续接收数据，拥塞状况将直接反馈到客户端。

 

第二级游戏逻辑服务：游戏服务中每个玩家有一个待处理消息队列，从网关接收到请求包之后如果检测到以下情况的发生将直接丢弃请求包，并向客户端返回busy:

 1 所有的待处理包数量超过某个预设阀值

2 玩家待处理包数量超过某个预设阀值

## 9. 战斗/房间服务

战斗/房间服务作为公共服务，为整个游戏服务。战斗/房间服务采用集群部署模式，每一组节点称为一个set。每个set共享一个数据存储服务以记录玩家战报数据。战斗/房间服务的扩容及缩容都以set为单位。

 玩家请求战斗时，服务端为玩家分配一个战斗服务，请求此服务创建战场/房间。请求成功后将此信息写入到玩家战斗信息中（战斗服务地址/战场编号）。并向玩家返回此信息。

 玩家接收到信息后连接战斗服务进入战场。

 战斗的断线重连：

玩家重连后，服务端检查战斗信息，如果有，将此信息发送给玩家，玩家重连战斗服。

 战斗结算：

![battle-balance.png](res/teacher-server/battle_balance.png)

战报的记录与gameserver无关，即使在写入战报时gameserver故障或玩家掉线都不会影响战报的记录以及后续的结算处理。